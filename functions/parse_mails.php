<?php//require_once(__DIR__.'/../Config.php');require_once(dirname(__FILE__).'/../Config.php');require_once(FRAME_WORK_PATH.'db/db_pgsql.php');require_once("common/imap.php");require_once("common/SimpleParser.php");require_once(FRAME_WORK_PATH."basic_classes/ParamsSQL.php");function parse_float($dig){	$res = '';	for($i=0;$i<strlen($dig);$i++){		if ($dig[$i]=='.'||$dig[$i]==','){			$res.='.';		}		else if (ord($dig[$i])>=ord('0')&&$dig[$i]<=ord('9')){			$res.=$dig[$i];		}	}	return (strlen($res))? floatval($res):0;}	//define('MAIL_LOGIN','bellagio-1@yandex.ru');	//define('MAIL_PWD','zakazibellagio');	define('MAIL_LOGIN','bellagioorder@mail.ru');	define('MAIL_PWD','123qwerty');		define('ORDER_MAIL','order@bellagio72.ru');		$dbLink = NULL;		$mail = new IMAPMail();	$mail->open(MAIL_LOGIN,MAIL_PWD);	$count = $mail->getCount();	//echo "count=".$count;	for ($i=1;$i<=$count;$i++){		$fromInfo = $mail->getHeader($i)->from[0];		$details = array(			"fromAddr" => (isset($fromInfo->mailbox) && isset($fromInfo->host))				? $fromInfo->mailbox . "@" . $fromInfo->host : "",			"fromName" => (isset($fromInfo->personal))				? $fromInfo->personal : "",			"subject" => (isset($header->subject))				? $header->subject : ""		);				if ($details["fromAddr"]==ORDER_MAIL){			$res = array();			$bodyText = $mail->getBody($i);						$number_from_site	= '';			$date				= NULL;			$client_name		= '';			$delivery_type		= NULL;			$client_tel			= '';			$delivery_date		= mktime();			$deliv_time_from 	= 'NULL';			$recipient_name 	= '';			$recipient_tel 		= '';			$recipient_type		= NULL;			$payment_type		= NULL;			$anonym_gift		= FALSE;			$delivery_note_type = NULL;						$extra_comment		= '';			$payed				= FALSE;			$total				= 0;			$card				= FALSE;			$card_text			= '';			$address			= '';			$order_products		= array();			$order_materials	= array();									if (strpos($bodyText,'Новый быстрый заказ')===FALSE){				//file_put_contents('d:\mail_'.$i.'.txt',$bodyText);				//continue;								//Номер				SimpleParser::parse($bodyText,					'Ваш заказ номер <strong style="margin: 0; font-family: '.chr(ord("'")).'Helvetica Neue'.chr(ord("'")).', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px;">',					'</strong>',					0,					$res);				$number_from_site = trim($res['val']);																//Дата				SimpleParser::parse($bodyText,					'от <strong style="margin: 0; font-family: '.chr(ord("'")).'Helvetica Neue'.chr(ord("'")).', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px;">',					'</strong>',					$res['from'],					$res);				$date = strtotime(trim($res['val']));												//Стоимость заказа				SimpleParser::parse($bodyText,					'Стоимость заказа:',					' руб',					$res['from'],					$res);				$total = parse_float(trim($res['val']));								//Состав заказа				SimpleParser::parse($bodyText,					'Состав заказа:</strong><br style="margin: 0; font-family: '.chr(ord("'")).'Helvetica Neue'.chr(ord("'")).', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px;">',					'</tr>',					$res['from'],					$res);				$order_cont = trim($res['val']);				while ($p=strpos($order_cont,'<br />')){					$order_cont_s = substr($order_cont,0,$p-1);					$p1 = strpos($order_cont_s,' -');					if ($p1>=0){						$prod_name = substr($order_cont_s,0,$p1-1);					}					$order_cont_s = substr($order_cont_s,$p1+3);										$p1 = strpos($order_cont_s,': ');					if ($p1>=0){						$prod_quant = parse_float(substr($order_cont_s,0,$p1-1));					}					$order_cont_s = substr($order_cont_s,$p1+2);					$prod_price = parse_float($order_cont_s);										if (strpos(strtolower($prod_name),'букет')!==FALSE){						array_push($order_products,array(							'id'=>0,							'name'=>$prod_name,							'quant'=>$prod_quant,							'price'=>$prod_price,							'total'=>round($prod_price*$prod_quant,2)							)						);					}					else{						array_push($order_materials,array(							'id'=>0,							'name'=>$prod_name,							'quant'=>$prod_quant,							'price'=>$prod_price,							'total'=>round($prod_price*$prod_quant,2)							)						);											}										$order_cont = substr($order_cont,$p+6);				}								//Дополнительная информация								//name				SimpleParser::parse($bodyText,					'Имя: ',					'<br>',					$res['from'],					$res);				$client_name = trim($res['val']);								//Телефон				SimpleParser::parse($bodyText,					'Телефон: ',					'<br>',					$res['from'],					$res);				$client_tel = trim($res['val']);								//Дата доставки				SimpleParser::parse($bodyText,					'Дата доставки: ',					'<br>',					$res['from'],					$res);				$delivery_date = strtotime(trim($res['val']));								//Время доставки				SimpleParser::parse($bodyText,					'Время доставки: ',					'<br>',					$res['from'],					$res);				$deliv_time_from = trim($res['val']);				$p = strpos($deliv_time_from,':');								if ($p>=0){					$deliv_time_from = substr($deliv_time_from,0,$p);				}				//Получатель				SimpleParser::parse($bodyText,					'Получатель: ',					'<br>',					$res['from'],					$res);				$recipient_type = (trim($res['val'])=='Я получатель')? 'self':'other';				$from = $res['from'];								if ($recipient_type=='other'){					SimpleParser::parse($bodyText,						'Имя получателя: ',						'<br>',						$from,						$res);					$recipient_name = trim($res['val']);					SimpleParser::parse($bodyText,						'Телефон получателя: ',						'<br>',						$res['from'],						$res);					$recipient_tel = trim($res['val']);										$from = $res['from'];				}								if (SimpleParser::parse($bodyText,					"Добавить открытку с текстом (это бесплатно):",					'<br>',					$from,					$res)				){										$card = (trim($res['val'])=='Да');					$from = $res['from'];					if ($card){						SimpleParser::parse($bodyText,							"Текст открытки:",							'<br>',							$from,							$res						);						$card_text = (trim($res['val']));						$from = $res['from'];										}				}								if (				SimpleParser::parse($bodyText,					'Сделать подарок анонимно: ',					'<br>',					$from,					$res)								){					$anonym_gift = (trim($res['val'])=='Да');					$from = $res['from'];														}				if (SimpleParser::parse($bodyText,					'Оповестить меня о доставке:',					'<br>',					$from,					$res)								){					$delivery_note = (trim($res['val'])=='Да');					$from = $res['from'];										if ($delivery_note){						SimpleParser::parse($bodyText,							'Тип оповещения:',							'<br>',							$from,							$res);											}					$delivery_note_type = (trim($res['val'])=='Звонок')? 'by_call':'by_sms';					$from = $res['from'];				}				if (SimpleParser::parse($bodyText,					'Дополнительные комментарий и пожелания: ',					'<br>',					$from,					$res)				){					$extra_comment = trim($res['val']);					$from = $res['from'];				}								SimpleParser::parse($bodyText,					'Адрес доставки: ',					'<br>',					$from,					$res);				$address = trim($res['val']);								//Платежная система				SimpleParser::parse($bodyText,					'</b> ',					'<br>',					$res['from'],					$res);				$pay_type_s = trim($res['val']);								$payed = (strpos($pay_type_s,'(оплачен)')!==FALSE);								if (strpos($pay_type_s,'Оплата наличными')!==FALSE){					$payment_type = 'cash';				}				else if (strpos($pay_type_s,'Банковские карты')!==FALSE){					$payment_type = 'bank';				}				else if (strpos($pay_type_s,'Яндекс.Деньги')!==FALSE){					$payment_type = 'yandex';				}				else if (strpos($pay_type_s,'Web Money')!==FALSE){					$payment_type = 'web_money';				}								//Доставка				SimpleParser::parse($bodyText,					'Служба доставки:</b> ',					'</p>',					$res['from'],					$res);				$delivery_type = (strpos(trim($res['val']),'Доставка курьером')!==FALSE)? 'courier':'by_client';							}			else{				//быстрый заказ				//file_put_contents('d:\mail_f_'.$i.'.txt',$bodyText);				//continue;				//exit;				//Номер				SimpleParser::parse($bodyText,					'Новый быстрый заказ с сайта Белладжио (',					')<br />',					0,					$res);				$number_from_site = trim($res['val']);								//Имя посетителя:				SimpleParser::parse($bodyText,					'Имя посетителя:',					'<br />',					$res['from'],					$res);				$client_name = trim($res['val']);								//Телефон:				SimpleParser::parse($bodyText,					'Телефон:',					'<br />',					$res['from'],					$res);				$client_tel = trim($res['val']);								//Состав заказа:				SimpleParser::parse($bodyText,					'Состав заказа:',					'Стоимость заказа',					$res['from'],					$res);				$order_cont = trim($res['val']);				//echo 'order_cont='.$order_cont.'</br>';				while ($p=strpos($order_cont,'<br />')){					$prod_name = '';					$prod_price = 0;					$prod_quant = 0;					$prod_total = 0;										$order_cont_ar = split(',',substr($order_cont,0,$p-1));					foreach ($order_cont_ar as $v){						$v_ar = split(':',$v);						if (count($v_ar)>=2){							$n = trim($v_ar[0]);							if ($n=='Название'){								$prod_name = trim($v_ar[1]);													}							else if ($n=='цена за единицу'){								$prod_price = parse_float(trim($v_ar[1]));							}							else if ($n=='количество'){								$prod_quant = parse_float(trim($v_ar[1]));							}							else if ($n=='стоимость'){								$prod_total = parse_float(trim($v_ar[1]));							}						}					}					if (strlen($prod_name)){						//echo 'prod_name='.$prod_name.'</br>';						if (strpos($prod_name,'Букет')!==FALSE){							//echo 'adding '.$prod_name.' to products</br>';							array_push($order_products,array(								'id'=>0,								'name'=>$prod_name,								'quant'=>$prod_quant,								'price'=>$prod_price,								'total'=>round($prod_price*$prod_quant,2)								)							);						}						else{							//echo 'adding '.$prod_name.' to materials</br>';							array_push($order_materials,array(								'id'=>0,								'name'=>$prod_name,								'quant'=>$prod_quant,								'price'=>$prod_price,								'total'=>round($prod_price*$prod_quant,2)								)							);												}					}					$order_cont = substr($order_cont,$p+6);				}				//Стоимость заказа				SimpleParser::parse($bodyText,					':',					' руб.<br />',					$res['from'],					$res);				$total = parse_float(trim($res['val']));								//Комментарий:				SimpleParser::parse($bodyText,					'Комментарий:',					'<br /><br />',					$res['from'],					$res);				$extra_comment = trim($res['val']);				//Заказ создан:				SimpleParser::parse($bodyText,					'Заказ создан:',					'Просмотр заказа на сайте:',					$res['from'],					$res);				$date = strtotime($res['val']);			}			/*			echo 'Num='.$number_from_site.'</br>';			echo '*** order_products=</br>';			var_dump($order_products);			echo '*** order_materials=</br>';			var_dump($order_materials);						continue;			*/			if (!$dbLink){				$dbLink = new DB_Sql();				$dbLink->appname = APP_NAME;				$dbLink->technicalemail = TECH_EMAIL;				$dbLink->reporterror = DEBUG;				$dbLink->server		= DB_SERVER_MASTER;				$dbLink->user		= DB_USER;				$dbLink->password	= DB_PASSWORD;				$dbLink->database	= DB_NAME;				$dbLink->connect(DB_SERVER_MASTER, DB_USER, DB_PASSWORD);			}						$par = new ParamsSQL(NULL,$dbLink);						$par->add('number_from_site',DT_STRING,$number_from_site);			$par->add('date',DT_STRING,date('Y-m-d',$date));			$par->add('client_name',DT_STRING,$client_name);						//$par->add('deliv_type',DT_STRING,$deliv_type);						$par->add('delivery_date',DT_STRING,date('Y-m-d',$delivery_date));			$par->add('client_tel',DT_STRING,$client_tel);			$par->add('deliv_time_from',DT_INT,$deliv_time_from);			$par->add('recipient_name',DT_STRING,$recipient_name);			$par->add('recipient_tel',DT_STRING,$recipient_tel);						//$par->add('recipient_type',DT_STRING,$recipient_type);			//$par->add('payment_type',DT_STRING,$payment_type);			$par->add('anonym_gift',DT_BOOL,$anonym_gift);			//$par->add('delivery_note_type',DT_STRING,$delivery_note_type);			$par->add('extra_comment',DT_STRING,$extra_comment);			$par->add('payed',DT_BOOL,$payed);			$par->add('total',DT_STRING,$total);			$par->add('card',DT_BOOL,$card);			$par->add('card_text',DT_STRING,$card_text);			$par->add('address',DT_STRING,$address);			$ar = $dbLink->query_first(			//throw new Exception(				"INSERT INTO doc_client_orders 				(				  date_time,				  delivery_type,				  client_name,				  client_tel,				  delivery_date,				  delivery_hour_id,				  card,				  card_text,				  anonym_gift,				  extra_comment,				  payment_type,				  recipient_name,				  recipient_tel,				  address,				  recipient_type,				  delivery_note_type,				  number_from_site,				  client_order_state,				  payed,				  total				  				)				VALUES(					".$par->getParamById('date').",					".(is_null($delivery_type)? 'NULL':"'".$delivery_type."'").",					".$par->getParamById('client_name').",					".$par->getParamById('client_tel').",					".$par->getParamById('delivery_date').",					(SELECT dh.id					FROM delivery_hours dh					WHERE dh.h_from=".$par->getParamById('deliv_time_from')."					),					".$par->getParamById('card').",					".$par->getParamById('card_text').",					".$par->getParamById('anonym_gift').",					".$par->getParamById('extra_comment').",					".(is_null($payment_type)? 'NULL':"'".$payment_type."'").",					".$par->getParamById('recipient_name').",					".$par->getParamById('recipient_tel').",					".$par->getParamById('address').",					".(is_null($recipient_type)? 'NULL':"'".$recipient_type."'").",					".(is_null($delivery_note_type)? 'NULL':"'".$delivery_note_type."'").",					".$par->getParamById('number_from_site').",					'to_noone'::client_order_states,					".$par->getParamById('payed').",					".$par->getParamById('total')."				)				RETURNING id");			if (is_array($ar)&&count($ar)&&count($order_products)){				$lines_q = '';				foreach($order_products AS $line){					if ($line['id']){						$lines_q.=($lines_q=='')? '':',';						$lines_q.=sprintf('(%d,%d,%f,%f,%f)',							$ar['id'],$line['id'],							$line['quant'],							$line['price'],							$line['total']						);					}				}				if (strlen($lines_q)){					$dbLink->query(					"INSERT INTO doc_client_orders_t_products					(doc_id,product_id,quant,price,total)					VALUES ".$lines_q);								}				//materials				$lines_q = '';				foreach($order_materials AS $line){					if ($line['id']){						$lines_q.=($lines_q=='')? '':',';						$lines_q.=sprintf('(%d,%d,%f,%f,%f)',							$ar['id'],$line['id'],							$line['quant'],							$line['price'],							$line['total']						);					}				}				if (strlen($lines_q)){					$dbLink->query(					"INSERT INTO doc_client_orders_t_products					(doc_id,product_id,quant,price,total)					VALUES ".$lines_q);								}							}			$mail->delete($i);					}			}	if ($dbLink){		$dbLink->close();	}?>